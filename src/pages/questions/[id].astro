---
import questionsData from '../../data/questions.json';
import Layout from '../../layouts/Layout.astro';
import { fromQuestionSlug, toQuestionSlug, withBase } from '../../lib/path';

interface QuestionItem {
  id: string;
  title: string;
  frequency: number;
  categoryName: string;
  companies: string[];
  variants: string[];
  aiSystemDesign: boolean;
  isHighFrequency: boolean;
}

export async function getStaticPaths() {
  const questions = questionsData as QuestionItem[];
  return questions.map((question) => ({
    params: {
      id: toQuestionSlug(question.id),
    },
    props: {
      question,
    },
  }));
}

const { question } = Astro.props as {
  question: QuestionItem;
};

const decodedId = fromQuestionSlug(Astro.params.id ?? question.id);
---

<Layout title={`${question.title} | InterviewGuide`} description={`${question.title} - 题目详情`}>
  <section class="py-12 px-6">
    <div class="max-w-5xl mx-auto">
      <div class="flex items-center justify-between gap-4 flex-wrap">
        <a href={withBase('/hot')} class="text-sm text-indigo-600 hover:underline">← 返回题库</a>
        <a href={withBase('/progress')} class="text-sm text-indigo-600 hover:underline">查看进度看板</a>
      </div>

      <article id="question-detail" data-question-id={decodedId} class="mt-6 bg-secondary rounded-2xl border border-slate-900/10 p-6 md:p-8">
        <div class="flex items-start justify-between gap-4 flex-wrap">
          <div>
            <p class="text-xs text-slate-500 mb-2">题目 ID: {decodedId}</p>
            <h1 class="text-2xl md:text-3xl font-bold leading-tight">{question.title}</h1>
          </div>
          <span class="shrink-0 text-sm font-bold px-3 py-1 rounded-full bg-indigo-500/10 text-indigo-600">
            频次 {question.frequency}
          </span>
        </div>

        <div class="mt-4 flex flex-wrap gap-2">
          <span class="tag tag-new">{question.categoryName}</span>
          {question.isHighFrequency && <span class="tag tag-learning">高频</span>}
          {question.aiSystemDesign && <span class="tag tag-mastered">AI 系统设计</span>}
        </div>

        <div class="mt-6 flex flex-wrap gap-3">
          <button id="favorite-toggle" type="button" class="rounded-xl px-4 py-2 text-sm font-semibold border border-slate-900/10 bg-tertiary">
            收藏
          </button>
          <button id="completed-toggle" type="button" class="rounded-xl px-4 py-2 text-sm font-semibold border border-slate-900/10 bg-tertiary">
            标记完成
          </button>
        </div>

        <p id="question-progress-status" class="text-sm text-slate-600 mt-3">当前状态：未收藏、未完成</p>

        <div class="mt-8">
          <h2 class="text-lg font-semibold">常见追问</h2>
          {question.variants.length > 0 ? (
            <ul class="mt-3 space-y-2 list-disc list-inside text-slate-600">
              {question.variants.map((variant) => (
                <li>{variant}</li>
              ))}
            </ul>
          ) : (
            <p class="mt-3 text-slate-600">暂无追问变体。</p>
          )}
        </div>

        <div class="mt-8">
          <h2 class="text-lg font-semibold">常见公司</h2>
          <div class="mt-3 flex flex-wrap gap-2">
            {question.companies.map((company) => (
              <span class="text-xs px-3 py-1 rounded-full bg-slate-900/5 text-slate-600 border border-slate-900/10">{company}</span>
            ))}
          </div>
        </div>
      </article>
    </div>
  </section>

  <script>
    import { loadProgressState, toggleCompletedQuestion, toggleFavoriteQuestion } from '../../lib/progress';

    (() => {
      const container = document.getElementById('question-detail');
      if (!(container instanceof HTMLElement)) return;

      const questionId = container.dataset.questionId ?? '';
      if (!questionId) return;

      const favoriteButton = document.getElementById('favorite-toggle');
      const completedButton = document.getElementById('completed-toggle');
      const statusNode = document.getElementById('question-progress-status');

      if (!(favoriteButton instanceof HTMLButtonElement)) return;
      if (!(completedButton instanceof HTMLButtonElement)) return;

      const renderState = () => {
        const progressState = loadProgressState();
        const isFavorite = progressState.favoriteIds.includes(questionId);
        const isCompleted = progressState.completedIds.includes(questionId);

        favoriteButton.textContent = isFavorite ? '已收藏' : '收藏';
        completedButton.textContent = isCompleted ? '已完成' : '标记完成';
        favoriteButton.dataset.active = isFavorite ? 'true' : 'false';
        completedButton.dataset.active = isCompleted ? 'true' : 'false';

        if (!(statusNode instanceof HTMLElement)) return;
        if (!isFavorite && !isCompleted) {
          statusNode.textContent = '当前状态：未收藏、未完成';
          return;
        }

        const labels = [];
        if (isFavorite) labels.push('已收藏');
        if (isCompleted) labels.push('已完成');
        statusNode.textContent = `当前状态：${labels.join(' · ')}`;
      };

      favoriteButton.addEventListener('click', () => {
        toggleFavoriteQuestion(questionId);
        renderState();
      });

      completedButton.addEventListener('click', () => {
        toggleCompletedQuestion(questionId);
        renderState();
      });

      window.addEventListener('storage', renderState);
      renderState();
    })();
  </script>

  <style is:inline>
    #favorite-toggle[data-active='true'],
    #completed-toggle[data-active='true'] {
      background: rgba(99, 102, 241, 0.12);
      border-color: rgba(99, 102, 241, 0.35);
      color: rgb(79, 70, 229);
    }
  </style>
</Layout>
